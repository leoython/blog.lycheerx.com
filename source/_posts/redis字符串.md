---
title: redis字符串
date: 2020-08-04 10:04:38
tags:
---
redis 并未使用C语言字符串来作为自己的字符串表示，凡是涉及到读写字符串的部分，redis都是用自己实现的sds来表示，C语言的字符串只用来作为一些不需要读写操作的字符串字面量。

## 什么是SDS

简单动态字符串-SDS是redis构建的一种字符串抽象表示，SDS的结构如下

```c
struct sdshdr {
	// 记录字符串长度
	// 等于sds保存的字符串长度
	int len;
	// 记录buf数组中未使用的字节的数量
	int free;
	// 字节数组，用于保存字符串
	char buf[];
}
```

## Q&A

### 为什么redis不使用C语言的字符串表示

1. 性能，redis本身需要极高的性能，如果使用C语言的字符串表示，那么在执行获取字符串长度的操作时就需要遍历字符串。使用SDS时这个操作永远是O(1)，即使即使在多次，也不会造成影响
2. SDS虽然用来存储字符串，但是并不是只能用来存储字符串，只要是二进制数据，都可以用SDS保存，C语言字符串中间不可以存在'\0'，导致无法存储二进制数据，像图片。视频等。而使用数据库来存储这一类数据的场景并不一定不存在，使用SDS也是redis为了这部分的实现考虑
3. 杜绝缓冲区溢出，C语言字符串在追加字符时不会判断当前字节数组长度是否足够, 所以会导致缓冲区溢出，甚至会覆盖别的变量，引发安全问题
4. 减少修改字符串时的内存分配次数，C语言字符串每次修改字符串，都需要对字节数组进行缩小或者扩展，而SDS则可以避免

### redis SDS与C语言字符串相同点

- 底层都是用字节数组存储字符串
- 字节数组最后都以'\0'结尾

### SDS何时会扩展字节数组以及如何扩展

- 当字符串需要拼接或者需要追加字符时，如果free的字节数量足够，此时不会扩展字节数组
- 当free的数量不足时，会扩展字节数组

    **扩展方式**

    - 如果修改后，SDS的长度小于1M，则会同时分配与字符串同等长度的空间，例如修改后字符串长度为13，则会分配13字节的未使用空间，此时SDS 的buf数组的实际长度是13+13+1=27，别忘了最后一位'\0'
    - 如果修改后，SDS的长度大于等于1M，则会同时分配1M的未使用空间

### SDS惰性回收

当需要缩短SDS保存的字符串时，程序并不立即回收缩短后多出来的字节，而是使用free属性保存，等待将来使用

### SDS其他知识点

- 二进制安全
- 兼容部分C语言的字符串函数

### SDS与C语言字符串

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b5954ae2-e977-4a5a-90d2-9744d361edc0/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/b5954ae2-e977-4a5a-90d2-9744d361edc0/Untitled.png)

## 小结

![https://s3-us-west-2.amazonaws.com/secure.notion-static.com/22819e08-d720-4e6b-8ff9-7b24d04f5ec7/Untitled.png](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/22819e08-d720-4e6b-8ff9-7b24d04f5ec7/Untitled.png)