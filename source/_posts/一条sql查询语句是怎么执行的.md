---
title: 一条sql查询语句是怎么执行的
date: 2020-08-02 21:39:43
tags: Mysql
---
## mysql 基本架构

{% asset_path slug %}

## 各部分职责

### 查询缓存

如果查询命中缓存，则直接返回结果

### 连接器

管理连接，权限验证

### 分析器

词法分析，语法分析

### 优化器

查询计划生成，索引选择等

### 执行器

调用存储引擎接口，执行查询，在此时也会做权限校验

### 存储引擎

存储数据，提供读写接口

## Q&A

### 查询命中缓存时，如果客户端没有权限，会发生什么？

查询命中缓存时，再返回结果前会做权限校验，如果权限不足则会返回错误

### 查询缓存有什么缺点？

查询缓存的失效非常频繁，只要有对一个表的更新，这个表上所有的查询缓存都会被清空。

所以最好只有当表是一张静态表，数据更新不频繁才推荐使用查询缓存

### 连接的一些知识点

- 当前连接的权限是在连接成功时读取的，也就是说，连接成功后更新权限，对当前连接不会生效
- 长连接内存涨的特别快是因为查询使用的临时内存是管理在连接对象里的，这些资源会等到连接断开才会释放。所以如果长连接累积下来，可能导致内存占用太大，被系统强行杀掉（OOM），从现象看就是 MySQL 异常重启了。

    解决方案：

    - 使用一段时间，定期断开长连接。或者程序里面判断执行过一个占用内存的大查询后，断开连接，之后要查询再重连。
    - 如果你用的是 MySQL 5.7 或更新版本，可以在每次执行一个比较大的操作后，通过执行 mysql_reset_connection 来重新初始化连接资源。这个过程不需要重连和重新做权限验证，但是会将连接恢复到刚刚创建完时的状态。

### 什么时候会做权限校验？

- 命中查询缓存返回结果前
- 执行优化器之前，会调用precheck做权限校验
- 执行器开始执行的时候

### 如果查询中使用了不存在的字段，此时会提示字段不存在，这个错误从哪里跑出来的？

分析器